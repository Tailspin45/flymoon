<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Telescope Control - Flymoon</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='telescope.css') }}">
</head>
<body>
    <div class="header-row">
        <a href="/" style="text-decoration: none;">
            <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Flymoon Transit Tracker" class="logo" />
        </a>
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 1.2em;">üî≠ Seestar S50 Control</div>
            <div id="lastUpdateStatus" style="font-size: 0.9em; color: #666; margin-top: 4px;"></div>
        </div>
        <a href="/" target="_blank" onclick="window.close(); return false;" class="btn-sm">‚Üê Back</a>
    </div>

    <div class="telescope-container">
        <!-- Status Message Area -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Main Layout: Sidebars + Preview + Filmstrip -->
        <div class="telescope-layout">
            
            <!-- Left Sidebar: Transits -->
            <div class="sidebar sidebar-left">
                <!-- Transit Auto-Capture Settings -->
                <div class="sidebar-panel">
                    <h3>üö® Transit Auto-Capture</h3>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <input type="checkbox" id="autoCaptureToggle" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Auto-Record Transits</span>
                        </label>
                    </div>
                    <div class="setting-info">
                        Automatically stop any recording and capture transits when detected within 15 seconds.
                    </div>
                </div>

                <!-- Transit Notifications -->
                <div class="sidebar-panel" id="transitPanel">
                    <h3>‚úàÔ∏è Upcoming Transits</h3>
                    <div id="transitList" class="transit-list">
                        <p class="empty-state">No transits detected</p>
                    </div>
                </div>
            </div>

            <!-- Center: Live Preview -->
            <div class="preview-area">
                <div class="preview-header">
                    <h2><span id="previewTitleIcon">‚ö´</span> Live Preview</h2>
                    <div class="preview-status" id="previewStatus">
                        <span class="status-dot" id="previewStatusDot"></span>
                        <span id="previewStatusText">Preview Inactive</span>
                    </div>
                </div>
                <div class="preview-wrapper">
                    <!-- Zoom Slider -->
                    <div class="zoom-slider">
                        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <input type="range" id="zoomSlider" min="50" max="300" value="100" step="1" orient="vertical" oninput="setZoom(this.value)">
                        <span id="zoomPercent" class="zoom-percent">100%</span>
                        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                        <button class="zoom-btn" onclick="zoomFit()" title="Fit to Window">‚ä°</button>
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <img id="previewImage" src="" alt="Live Preview" style="display: none;">
                        <div class="preview-placeholder" id="previewPlaceholder">
                            <div class="placeholder-icon">üìπ</div>
                            <div class="placeholder-text">Connect telescope to view live stream</div>
                        </div>
                        <!-- Transit Capture Overlay -->
                        <div id="transitOverlay" class="transit-overlay" style="display: none;">
                            <div class="transit-overlay-content">
                                <div class="transit-overlay-icon">üéØ</div>
                                <div class="transit-overlay-text">TRANSIT CAPTURE IN PROGRESS</div>
                                <div id="transitOverlayInfo" class="transit-overlay-info"></div>
                            </div>
                        </div>
                        <!-- Simulation overlays (hidden until sim active) -->
                        <div id="simBadge" style="display:none; position:absolute; top:8px; left:8px; background:rgba(255,200,0,0.85); color:#000; font-weight:bold; font-size:0.75em; padding:2px 7px; border-radius:4px; letter-spacing:1px; pointer-events:none; z-index:20;">SIM</div>
                        <div id="simCountdownOverlay" style="display:none; position:absolute; bottom:12px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.65); color:#fff; font-size:1.4em; font-weight:bold; padding:4px 18px; border-radius:8px; pointer-events:none; z-index:20; white-space:nowrap;"></div>
                        <div id="simRecOverlay" style="display:none; position:absolute; top:8px; right:8px; color:#f00; font-weight:bold; font-size:0.85em; pointer-events:none; z-index:20;">‚óè REC</div>
                        <div id="simFlash" style="display:none; position:absolute; inset:0; background:#fff; pointer-events:none; z-index:25;"></div>
                        <div id="simPlane" style="display:none; position:absolute; pointer-events:none; z-index:22; transition:none;">
                            <img src="/static/images/sim_plane.png" width="95" height="80" alt="">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Controls -->
            <div class="sidebar sidebar-right">
                
                <!-- Connection Panel -->
                <div class="sidebar-panel sidebar-panel-compact">
                    <h3>üîå Connection</h3>
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="connectionStatus">Disconnected</span>
                    </div>
                    <div class="button-group">
                        <button id="connectBtn" class="btn btn-primary" onclick="connect()">Connect</button>
                        <button id="disconnectBtn" class="btn btn-secondary" onclick="disconnect()" disabled>Disconnect</button>
                        <button id="simulateBtn" class="btn btn-info" onclick="toggleSimulation()">Simulate</button>
                    </div>
                </div>

                <!-- Target Selection Panel -->
                <div class="sidebar-panel">
                    <h3>üéØ Target</h3>
                    <div class="target-compact target-button" id="sunStatus" onclick="switchToSun()">
                        <span class="target-icon">‚òÄÔ∏è</span>
                        <div class="target-info">
                            <div class="target-name">Sun</div>
                            <div class="target-coords" id="sunCoords">--</div>
                        </div>
                        <span class="visibility-badge" id="sunBadge">--</span>
                    </div>
                    <div class="target-compact target-button" id="moonStatus" onclick="switchToMoon()">
                        <span class="target-icon">üåô</span>
                        <div class="target-info">
                            <div class="target-name">Moon</div>
                            <div class="target-coords" id="moonCoords">--</div>
                        </div>
                        <span class="visibility-badge" id="moonBadge">--</span>
                    </div>
                    <div id="targetWarning" class="warning-box" style="display: none;"></div>
                </div>

                <!-- Capture Controls Panel -->
                <div class="sidebar-panel">
                    <h3>üì∏ Capture</h3>
                    
                    <!-- Photo Capture -->
                    <div class="capture-compact">
                        <div class="capture-header-compact">
                            <span>üì∑ Photo</span>
                        </div>
                        <button id="capturePhotoBtn" class="btn btn-primary btn-compact" onclick="capturePhoto()" disabled>Capture</button>
                    </div>

                    <!-- Video Recording -->
                    <div class="capture-compact">
                        <div class="capture-header-compact">
                            <span>üìπ Video</span>
                        </div>
                        <div class="input-row">
                            <input type="number" id="videoDuration" value="30" min="1" max="3600" step="1" class="input-compact" placeholder="Duration (s)">
                            <input type="number" id="frameInterval" value="0" min="0" max="60" step="0.1" class="input-compact" placeholder="Interval" title="0 = normal, >0 = timelapse">
                        </div>
                        <div class="recording-status-compact" id="recordingStatus">
                            <span class="status-dot" id="recordingDot"></span>
                            <span id="recordingText">Ready</span>
                            <span id="recordingTimer"></span>
                        </div>
                        <div class="button-group">
                            <button id="startRecordingBtn" class="btn btn-primary btn-compact" onclick="startRecording()" disabled>‚è∫Ô∏è Record</button>
                            <button id="stopRecordingBtn" class="btn btn-danger btn-compact" onclick="stopRecording()" disabled style="display: none;">‚èπÔ∏è Stop</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Filmstrip -->
        <div class="filmstrip">
            <div class="filmstrip-header">
                <span class="filmstrip-title">üìÅ Captured Files (<span id="fileCount">0</span>)</span>
                <div class="filmstrip-controls">
                    <button id="refreshFilesBtn" class="btn-icon" onclick="refreshFiles()" disabled title="Refresh">üîÑ</button>
                    <button id="expandFilesBtn" class="btn-icon" onclick="toggleFilesModal()" disabled title="Show all files">‚õ∂</button>
                </div>
            </div>
            <div id="filmstripList" class="filmstrip-list">
                <p class="empty-state">No files captured yet</p>
            </div>
        </div>

        <!-- Full Files Modal -->
        <div id="filesModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>üìÅ All Captured Files</h2>
                    <button class="modal-close" onclick="toggleFilesModal()">‚úï</button>
                </div>
                <div id="filesGrid" class="files-grid-modal">
                    <p class="empty-state">No files</p>
                </div>
            </div>
        </div>

        <!-- File Viewer Lightbox -->
        <div id="fileViewer" class="modal" style="display: none;" onclick="closeFileViewer()">
            <div class="modal-content" style="max-width: 95vw; max-height: 95vh; background: #111; padding: 0; overflow: hidden;" onclick="event.stopPropagation()">
                <div class="modal-header" style="background: #222; padding: 8px 12px;">
                    <span id="fileViewerName" style="color: #eee; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    <button class="modal-close" onclick="closeFileViewer()">‚úï</button>
                </div>
                <div id="fileViewerBody" style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
                </div>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='telescope.js') }}?v=1771610000"></script>
</body>
</html>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flymoon app</title>
    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}?v=1770230886">
    <!-- Leaflet CSS (self-hosted for security) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}" />
    <link rel="stylesheet" href="{{ url_for('static', filename='telescope.css') }}">
</head>
<body>
<div id="mapView">
    <div class="header-row">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Flymoon Transit Tracker" class="logo" />
        <div style="flex: 1; text-align: center;">
            <span id="trackingStatus" class="status-text"></span>
            <div id="lastUpdateStatus" style="font-size: 0.85em; color: #ccc; margin-top: 4px;"></div>
            <div id="celestialPositions" style="font-size: 0.85em; color: #ddd; margin-top: 2px;"></div>
        </div>
        <div style="display: flex; gap: 8px;">
            <button class="btn-sm" onclick="showPanel('telescope')" title="Control Telescope" style="position: relative;">
                ğŸ”­ Telescope
                <span id="telescopeStatusLight" style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background-color: #999;" title="Telescope disconnected"></span>
            </button>
            <button class="btn-sm" onclick="toggleNearMissLog()" title="Near-miss history">ğŸ“‹ Near Misses</button>
        </div>
        <!-- Quadrant Min Altitude Control -->
        <div class="quadrant-circle">
            <!-- Labels outside circle -->
            <label class="quadrant-label quadrant-label-n">N</label>
            <label class="quadrant-label quadrant-label-e">E</label>
            <label class="quadrant-label quadrant-label-s">S</label>
            <label class="quadrant-label quadrant-label-w">W</label>
            <!-- Inputs inside quadrants -->
            <input type="number" id="minAltN" class="quadrant-input quadrant-input-n" placeholder="30" min="0" max="90" title="North Min Altitude (Â°)">
            <input type="number" id="minAltE" class="quadrant-input quadrant-input-e" placeholder="30" min="0" max="90" title="East Min Altitude (Â°)">
            <input type="number" id="minAltS" class="quadrant-input quadrant-input-s" placeholder="30" min="0" max="90" title="South Min Altitude (Â°)">
            <input type="number" id="minAltW" class="quadrant-input quadrant-input-w" placeholder="30" min="0" max="90" title="West Min Altitude (Â°)">
            <div class="quadrant-center" onclick="resetQuadrantValues()" title="Click to reset all to 0">Min Angle</div>
        </div>
    </div>

    <!-- Near-miss log panel -->
    <div id="nearMissPanel" style="display:none; background:#1a1a2e; border-bottom:1px solid #333; padding:10px 16px; max-height:340px; overflow-y:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong style="color:#ddd;">ğŸ“‹ Historical Near Misses â€” closest angular approach per flight (sorted by separation)</strong>
            <button onclick="toggleNearMissLog()" style="background:none;border:none;color:#aaa;cursor:pointer;font-size:1.1em;">âœ•</button>
        </div>
        <div id="nearMissContent" style="color:#bbb; font-size:0.85em;">Loadingâ€¦</div>
    </div>

    <div class="controls-row">
        <button id="goBtn" class="btn-primary" onclick="go();" title="Force immediate API refresh (not recommended - wastes quota)">âŸ³ Force Refresh</button>
        <span class="separator">|</span>
        <div class="control-group">
            <input type="number" id="latitude" placeholder="Lat" autocomplete="on" title="Latitude">
            <div class="control-label">Observer Lat</div>
        </div>
        <div class="control-group">
            <input type="number" id="longitude" placeholder="Lon" autocomplete="on" title="Longitude">
            <div class="control-label">Observer Lon</div>
        </div>
        <div class="control-group">
            <input type="number" id="elevation" placeholder="Elev" autocomplete="on" title="Elevation (m)">
            <div class="control-label">Elevation (m)</div>
        </div>
        <span class="separator">|</span>
        <div class="control-group">
            <button class="btn-sm" onclick="savePosition()" title="Save position">ğŸ’¾</button>
            <div class="control-label">Save</div>
        </div>
        <div class="control-group">
            <button class="btn-sm btn-lg-icon" onclick="clearPosition()" title="Clear">âœ•</button>
            <div class="control-label">Clear</div>
        </div>
        <span class="separator">|</span>
        <div class="control-group">
            <button class="btn-sm" onclick="toggleMap()" title="Toggle map">ğŸ—ºï¸</button>
            <div class="control-label">Map</div>
        </div>
        <div class="control-group">
            <button class="btn-sm" onclick="toggleAlerts()" title="Enable/disable alerts">ğŸ””</button>
            <div class="control-label">Alerts</div>
        </div>
        <span class="separator">|</span>
        <div style="display: inline-block; text-align: center;">
            <input type="checkbox" id="pauseWhenHidden" onchange="togglePauseWhenHidden()" title="Pause auto-refresh when page is hidden" style="width: 18px; height: 18px; cursor: pointer;">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Pause Hidden</div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loadingSpinner" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading flight data...</p>
    </div>

    <div id="transitCountdown" style="display: none; text-align: center; font-size: 1.5em; font-weight: bold; padding: 15px; margin: 10px 0; border-radius: 5px;"></div>

    <div id="mapContainer" style="display: none;">
        <div style="display: flex; align-items: flex-start; gap: 0;">
            <div id="map" style="height: 500px; flex: 1; margin: 20px 0;"></div>
            <!-- Altitude Overlay -->
            <div id="altitudeOverlay">
                <div class="altitude-header">Aircraft Altitudes</div>
                <div class="altitude-scale">
                    <div class="altitude-tick" style="top: 0%;">45k</div>
                    <div class="altitude-tick" style="top: 11.1%;">40k</div>
                    <div class="altitude-tick" style="top: 22.2%;">35k</div>
                    <div class="altitude-tick" style="top: 33.3%;">30k</div>
                    <div class="altitude-tick" style="top: 44.4%;">25k</div>
                    <div class="altitude-tick" style="top: 55.6%;">20k</div>
                    <div class="altitude-tick" style="top: 66.7%;">15k</div>
                    <div class="altitude-tick" style="top: 77.8%;">10k</div>
                    <div class="altitude-tick" style="top: 88.9%;">5k</div>
                    <div class="altitude-tick" style="top: 100%;">0</div>
                </div>
                <div class="altitude-grid">
                    <div class="altitude-grid-line" style="bottom: 100%;"></div>
                    <div class="altitude-grid-line" style="bottom: 88.9%;"></div>
                    <div class="altitude-grid-line" style="bottom: 77.8%;"></div>
                    <div class="altitude-grid-line" style="bottom: 66.7%;"></div>
                    <div class="altitude-grid-line" style="bottom: 55.6%;"></div>
                    <div class="altitude-grid-line" style="bottom: 44.4%;"></div>
                    <div class="altitude-grid-line" style="bottom: 33.3%;"></div>
                    <div class="altitude-grid-line" style="bottom: 22.2%;"></div>
                    <div class="altitude-grid-line" style="bottom: 11.1%;"></div>
                    <div class="altitude-grid-line" style="bottom: 0%;"></div>
                </div>
                <div id="altitudeBars"></div>
            </div>
        </div>
        <div id="mapLegend" style="padding: 10px; background: #f0f0f0; margin-bottom: 10px;">
            <strong>Legend:</strong>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #FF0000; border: 1px solid white; border-radius: 50%; box-shadow: 0 0 3px rgba(0,0,0,0.6); vertical-align: middle;"></span> Observer</span>
            <span style="margin-left: 10px;">âœˆï¸ Aircraft</span>
            <span style="margin-left: 10px; color: #32CD32;">â—† High (â‰¤1Â°)</span>
            <span style="margin-left: 10px; color: #FF8C00;">â—† Medium (â‰¤2Â°)</span>
            <span style="margin-left: 10px; color: #808080;">â—† Low (â‰¤3Â°)</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #FF4500; vertical-align: middle;"></span> Sun azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #4169E1; vertical-align: middle;"></span> Moon azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 3px; background: repeating-linear-gradient(90deg, #4169E1 0, #4169E1 10px, transparent 10px, transparent 20px); vertical-align: middle;"></span> Planned route</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 3px; background: repeating-linear-gradient(90deg, #000 0, #000 10px, transparent 10px, transparent 15px); vertical-align: middle;"></span> ADS-B track</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 6px; height: 6px; background: #888; border-radius: 50%; vertical-align: middle;"></span> Ghost trail</span>
        </div>
    </div>

    <div id="results">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>target</th>
                    <th>id</th>
                    <th>type</th>
                    <th style="max-width: 60px; overflow: hidden; text-overflow: ellipsis;">origin</th>
                    <th style="max-width: 60px; overflow: hidden; text-overflow: ellipsis;">dest</th>
                    <th>target<br>angle</th>
                    <th>plane<br>angle</th>
                    <th>target<br>az</th>
                    <th>plane<br>az</th>
                    <th>â–³angle</th>
                    <th>â–³az</th>
                    <th>elev</th>
                    <th>GPS alt<br>(ft)</th>
                    <th>Hdg (T)</th>
                    <th>dist<br>(km/miles)</th>
                    <th>speed<br>(mph)</th>
                    <th title="Position data source: FA=FlightAware, OS=OpenSky, ADS-B=direct">src</th>
                </tr>
            </thead>
            <tbody id="flightData">
            </tbody>
        </table>
    </div>
    <h3 class="alert" id="noResults"></h3>
    <h3 class="alert" id="targetUnderHorizon"></h3>
    <div id="errorBanner" style="display:none; background:#ffebee; border:1px solid #f44336; border-radius:6px; padding:12px 16px; margin:10px 0; color:#b71c1c; font-family:monospace; font-size:13px; white-space:pre-wrap; word-break:break-word;"></div>

    <footer class="attribution-footer">
        <p><i>Created with deep appreciation for the idea and initial design by David Betancourt Montellano</i></p>
        <p><i>Creado con profundo agradecimiento por la idea y el diseÃ±o inicial de David Betancourt Montellano</i></p>
    </footer>

    <audio id="alertSound" src="{{ url_for('static', filename='sounds/tissman-alert1-maximum-distortion.mp3') }}" preload="auto">
    </audio>
</div><!-- #mapView -->

<div id="telescopeView" style="display:none">
    <!-- Eclipse Outlook/Watch/Warning banner -->
    <div id="eclipseBanner" class="eclipse-banner" style="display:none">
        <span id="eclipseBannerIcon"></span>
        <span id="eclipseBannerText"></span>
        <button class="eclipse-banner-dismiss" onclick="dismissEclipseBanner()" title="Dismiss">âœ•</button>
    </div>
    <!-- Target mismatch warning: scope is on Sun but a lunar transit is coming (or vice versa) -->
    <div id="mismatchBanner" style="display:none; background:#7a3a00; color:#ffe0a0; padding:8px 14px; align-items:center; gap:10px; font-size:0.92em; border-bottom:1px solid #b85c00;">
        <span id="mismatchText" style="flex:1"></span>
        <button id="mismatchSwitchBtn" style="background:#c06000; color:#fff; border:none; border-radius:4px; padding:4px 10px; cursor:pointer; white-space:nowrap;"></button>
        <button onclick="dismissMismatchBanner()" style="background:none; border:none; color:#ffe0a0; cursor:pointer; font-size:1.1em; padding:0 4px;">âœ•</button>
    </div>
    <div class="header-row">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Flymoon Transit Tracker" class="logo" />
        <div style="flex: 1; text-align: center;">
            <div style="font-size: 1.2em;">ğŸ”­ Seestar Control</div>
        </div>
        <button class="btn-sm" onclick="showPanel('map')">â† Map</button>
    </div>

    <div class="telescope-container">
        <!-- Status Message Area -->
        <div id="statusMessage" class="status-message"></div>

        <!-- Main Layout: Sidebars + Preview + Filmstrip -->
        <div class="telescope-layout">

            <!-- Left Sidebar: Transits -->
            <div class="sidebar sidebar-left">
                <!-- Transit Auto-Capture Settings -->
                <div class="sidebar-panel">
                    <h3>ğŸš¨ Transit Auto-Capture</h3>
                    <div class="setting-item">
                        <label class="toggle-label">
                            <input type="checkbox" id="autoCaptureToggle" checked>
                            <span class="toggle-slider"></span>
                            <span class="toggle-text">Auto-Record Transits</span>
                        </label>
                    </div>
                    <div class="setting-info">
                        Automatically stop any recording and capture transits when detected within 15 seconds.
                    </div>
                </div>

                <!-- Transit Notifications -->
                <div class="sidebar-panel" id="transitPanel">
                    <!-- Eclipse watch/warning/active card â€” shown when eclipse is imminent/active -->
                    <div id="eclipseCard" style="display:none"></div>
                    <h3>âœˆï¸ Upcoming Transits</h3>
                    <div id="transitList" class="transit-list">
                        <p class="empty-state">No transits detected</p>
                    </div>
                </div>
            </div>

            <!-- Center: Live Preview -->
            <div class="preview-area">
                <div class="preview-header">
                    <h2><span id="previewTitleIcon">âš«</span> Live Preview</h2>
                    <div class="preview-status" id="previewStatus">
                        <span class="status-dot" id="previewStatusDot"></span>
                        <span id="previewStatusText">Preview Inactive</span>
                    </div>
                </div>
                <div class="preview-wrapper">
                    <!-- Zoom Slider -->
                    <div class="zoom-slider">
                        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
                        <input type="range" id="zoomSlider" min="50" max="300" value="100" step="1" orient="vertical" oninput="setZoom(this.value)">
                        <span id="zoomPercent" class="zoom-percent">100%</span>
                        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">âˆ’</button>
                        <button class="zoom-btn" onclick="zoomFit()" title="Fit to Window">âŠ¡</button>
                    </div>
                    <div class="preview-container" id="previewContainer">
                        <img id="previewImage" src="" alt="Live Preview" style="display: none;">
                        <div class="preview-placeholder" id="previewPlaceholder">
                            <div class="placeholder-icon">ğŸ“¹</div>
                            <div class="placeholder-text">Connect telescope to view live stream</div>
                        </div>
                        <!-- Transit Capture Overlay -->
                        <div id="transitOverlay" class="transit-overlay" style="display: none;">
                            <div class="transit-overlay-content">
                                <div class="transit-overlay-icon">ğŸ¯</div>
                                <div class="transit-overlay-text">TRANSIT CAPTURE IN PROGRESS</div>
                                <div id="transitOverlayInfo" class="transit-overlay-info"></div>
                            </div>
                        </div>
                        <!-- Simulation overlays (hidden until sim active) -->
                        <div id="simBadge" style="display:none; position:absolute; top:8px; left:8px; background:rgba(255,200,0,0.85); color:#000; font-weight:bold; font-size:0.75em; padding:2px 7px; border-radius:4px; letter-spacing:1px; pointer-events:none; z-index:20;">SIM</div>
                        <div id="simCountdownOverlay" style="display:none; position:absolute; bottom:12px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.65); color:#fff; font-size:1.4em; font-weight:bold; padding:4px 18px; border-radius:8px; pointer-events:none; z-index:20; white-space:nowrap;"></div>
                        <div id="simRecOverlay" style="display:none; position:absolute; top:8px; right:8px; color:#f00; font-weight:bold; font-size:0.85em; pointer-events:none; z-index:20;">â— REC</div>
                        <div id="simFlash" style="display:none; position:absolute; inset:0; background:#fff; pointer-events:none; z-index:25;"></div>
                        <div id="simPlane" style="display:none; position:absolute; pointer-events:none; z-index:22; transition:none;">
                            <img src="/static/images/sim_plane.png" width="95" height="80" alt="">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Sidebar: Controls -->
            <div class="sidebar sidebar-right">

                <!-- Connection Panel -->
                <div class="sidebar-panel sidebar-panel-compact">
                    <h3>ğŸ”Œ Connection</h3>
                    <div class="status-indicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="connectionStatus">Disconnected</span>
                    </div>
                    <div class="button-grid-2x2">
                        <button id="connectBtn" class="btn btn-primary" onclick="connect()">Connect</button>
                        <button id="disconnectBtn" class="btn btn-secondary" onclick="disconnect()" disabled>Disconnect</button>
                        <button id="simulateBtn" class="btn btn-info" onclick="toggleSimulation()">Simulate</button>
                        <button id="simEclipseBtn" class="btn btn-eclipse" onclick="toggleSimEclipse()" title="Simulate a full eclipse alert sequence (Watch â†’ Warning â†’ Active â†’ Cleared)">ğŸŒ‘ Sim Eclipse</button>
                    </div>
                    <!-- Eclipse sim controls â€” shown only while sim eclipse is running -->
                    <div id="simEclipseControls" style="display:none; margin-top:8px">
                        <select id="simEclipseType" class="sim-eclipse-select">
                            <option value="lunar_total">ğŸŒ™ Total Lunar</option>
                            <option value="lunar_partial">ğŸŒ™ Partial Lunar</option>
                            <option value="solar_partial">â˜€ï¸ Partial Solar</option>
                            <option value="solar_total">â˜€ï¸ Total Solar</option>
                            <option value="solar_annular">â˜€ï¸ Annular Solar</option>
                        </select>
                        <label class="sim-eclipse-check">
                            <input type="checkbox" id="simEclipseOutlook" onchange="toggleSimEclipseOutlook(this.checked)">
                            Show Outlook Banner
                        </label>
                        <button id="simFireTransitBtn" class="btn btn-sm btn-transit-fire" onclick="fireSimTransitDuringEclipse()" style="display:none" title="Inject an aircraft transit during the eclipse to demo recording extension + âœˆï¸ marker">âœˆï¸ Fire Transit</button>
                    </div>
                </div>

                <!-- Target Selection Panel -->
                <div class="sidebar-panel">
                    <h3>ğŸ¯ Target</h3>
                    <div class="target-compact target-button" id="sunStatus" onclick="switchToSun()">
                        <span class="target-icon">â˜€ï¸</span>
                        <div class="target-info">
                            <div class="target-name">Sun</div>
                            <div class="target-coords" id="sunCoords">--</div>
                        </div>
                        <span class="visibility-badge" id="sunBadge">--</span>
                    </div>
                    <div class="target-compact target-button" id="moonStatus" onclick="switchToMoon()">
                        <span class="target-icon">ğŸŒ™</span>
                        <div class="target-info">
                            <div class="target-name">Moon</div>
                            <div class="target-coords" id="moonCoords">--</div>
                        </div>
                        <span class="visibility-badge" id="moonBadge">--</span>
                    </div>
                    <div id="targetWarning" class="warning-box" style="display: none;"></div>
                </div>

                <!-- Capture Controls Panel -->
                <div class="sidebar-panel">
                    <h3>ğŸ“¸ Capture</h3>

                    <!-- Photo Capture -->
                    <div class="capture-compact">
                        <div class="capture-header-compact">
                            <span>ğŸ“· Photo</span>
                        </div>
                        <div class="button-group">
                            <button id="capturePhotoBtn" class="btn btn-primary btn-compact" onclick="capturePhoto()" disabled>ğŸ“· Capture</button>
                        </div>
                    </div>

                    <!-- Video Recording -->
                    <div class="capture-compact">
                        <div class="capture-header-compact">
                            <span>ğŸ“¹ Video</span>
                        </div>
                        <div class="input-row">
                            <input type="number" id="videoDuration" value="30" min="1" max="3600" step="1" class="input-compact" placeholder="Duration (s)">
                            <input type="number" id="frameInterval" value="0" min="0" max="60" step="0.1" class="input-compact" placeholder="Interval" title="0 = normal, >0 = timelapse">
                        </div>
                        <div class="recording-status-compact" id="recordingStatus">
                            <span class="status-dot" id="recordingDot"></span>
                            <span id="recordingText">Ready</span>
                            <span id="recordingTimer"></span>
                        </div>
                        <div class="button-group">
                            <button id="startRecordingBtn" class="btn btn-primary btn-compact" onclick="startRecording()" disabled>âºï¸ Record</button>
                            <button id="stopRecordingBtn" class="btn btn-danger btn-compact" onclick="stopRecording()" disabled style="display: none;">â¹ï¸ Stop</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Bottom Filmstrip -->
        <div class="filmstrip">
            <div class="filmstrip-header">
                <span class="filmstrip-title">ğŸ“ Captured Files (<span id="fileCount">0</span>)</span>
                <div class="filmstrip-controls">
                    <button id="refreshFilesBtn" class="btn-icon" onclick="refreshFiles()" disabled title="Refresh">ğŸ”„</button>
                    <button id="expandFilesBtn" class="btn-icon" onclick="toggleFilesModal()" disabled title="Show all files">â›¶</button>
                </div>
            </div>
            <div id="filmstripList" class="filmstrip-list">
                <p class="empty-state">No files captured yet</p>
            </div>
        </div>

        <!-- Full Files Modal -->
        <div id="filesModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>ğŸ“ All Captured Files</h2>
                    <button class="modal-close" onclick="toggleFilesModal()">âœ•</button>
                </div>
                <div id="filesGrid" class="files-grid-modal">
                    <p class="empty-state">No files</p>
                </div>
            </div>
        </div>

        <!-- File Viewer Lightbox -->
        <div id="fileViewer" class="modal" style="display: none;" onclick="closeFileViewer()">
            <div class="modal-content" style="max-width: 95vw; max-height: 95vh; background: #111; padding: 0; overflow: hidden;" onclick="event.stopPropagation()">
                <div class="modal-header" style="background: #222; padding: 8px 12px;">
                    <span id="fileViewerName" style="color: #eee; font-size: 0.9em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"></span>
                    <button class="modal-close" onclick="closeFileViewer()">âœ•</button>
                </div>
                <div id="fileViewerBody" style="display: flex; align-items: center; justify-content: center; min-height: 200px;">
                </div>
            </div>
        </div>
    </div>
</div><!-- #telescopeView -->

    <!-- Leaflet JS and plugins (self-hosted for security) -->
    <script src="{{ url_for('static', filename='leaflet.js') }}"
        crossorigin=""></script>
    <!-- Leaflet Editable plugin for bounding box editing -->
    <script src="{{ url_for('static', filename='leaflet-editable.js') }}"></script>
    <script src="{{ url_for('static', filename='telescope.js') }}?v=1771610000" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='map.js') }}?v=1771600000" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='app.js') }}?v=1771610000" charset="utf-8"></script>

    <script>
        function showPanel(name) {
            document.getElementById('mapView').style.display        = (name === 'map')       ? '' : 'none';
            document.getElementById('telescopeView').style.display  = (name === 'telescope') ? '' : 'none';
            if (name === 'telescope' && typeof initTelescope    === 'function') initTelescope();
            if (name === 'map'       && typeof destroyTelescope === 'function') destroyTelescope();
        }

        let _nearMissLoaded = false;
        function toggleNearMissLog() {
            const panel = document.getElementById('nearMissPanel');
            const visible = panel.style.display !== 'none';
            panel.style.display = visible ? 'none' : 'block';
            if (!visible && !_nearMissLoaded) {
                _nearMissLoaded = true;
                fetch('/transit-log')
                    .then(r => r.json())
                    .then(data => {
                        const lvlLabel = l => l >= 3 ? 'ğŸŸ¢ HIGH' : l === 2 ? 'ğŸŸ  MED' : 'âšª LOW';
                        const targetIcon = t => t === 'sun' ? 'â˜€ï¸' : t === 'moon' ? 'ğŸŒ™' : t;
                        const scopeIcon = (connected, mode) => {
                            if (connected === '' || connected === undefined) return '<span title="No data">â€”</span>';
                            const on = connected === 'True' || connected === true;
                            if (!on) return '<span style="color:#888" title="Scope disconnected">ğŸ”­âœ—</span>';
                            const m = (mode||'').toLowerCase();
                            if (m === 'sun')  return '<span style="color:#ffcc00" title="Scope on Sun">ğŸ”­â˜€ï¸</span>';
                            if (m === 'moon') return '<span style="color:#aaddff" title="Scope on Moon">ğŸ”­ğŸŒ™</span>';
                            return '<span style="color:#88ff88" title="Scope connected">ğŸ”­âœ“</span>';
                        };
                        let html = '<table style="width:100%;border-collapse:collapse;font-size:0.82em;">';
                        html += '<thead><tr style="color:#fff;border-bottom:1px solid #444;">' +
                            '<th style="text-align:left;padding:3px 6px">Date</th>' +
                            '<th style="text-align:left;padding:3px 6px">Flight</th>' +
                            '<th style="padding:3px 6px">Type</th>' +
                            '<th style="padding:3px 6px">Target</th>' +
                            '<th style="padding:3px 6px">AltÂ°</th>' +
                            '<th style="padding:3px 6px">AzÂ°</th>' +
                            '<th style="padding:3px 6px">SepÂ°</th>' +
                            '<th style="padding:3px 6px">ETA min</th>' +
                            '<th style="padding:3px 6px">Level</th>' +
                            '<th style="padding:3px 6px" title="Scope connected and mode at time of detection">Scope</th>' +
                            '<th style="text-align:left;padding:3px 6px">Route</th>' +
                            '</tr></thead><tbody>';
                        data.forEach((e, i) => {
                            const bg = i % 2 === 0 ? '#1e1e35' : '#161628';
                            const sepColor = e.sep <= 0.25 ? '#ff4444' : e.sep <= 0.5 ? '#ff9900' : '#cccccc';
                            html += `<tr style="background:${bg}">` +
                                `<td style="padding:3px 6px">${e.date.replace(/(\d{4})(\d{2})(\d{2})/, '$1-$2-$3')}</td>` +
                                `<td style="padding:3px 6px"><strong>${e.flight}</strong></td>` +
                                `<td style="text-align:center;padding:3px 6px">${e.aircraft_type || 'â€”'}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${targetIcon(e.target)}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${e.alt_diff.toFixed(3)}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${e.az_diff.toFixed(3)}</td>` +
                                `<td style="text-align:center;padding:3px 6px;color:${sepColor};font-weight:bold">${e.sep.toFixed(3)}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${e.time ? parseFloat(e.time).toFixed(1) : 'â€”'}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${lvlLabel(e.possibility_level)}</td>` +
                                `<td style="text-align:center;padding:3px 6px">${scopeIcon(e.scope_connected, e.scope_mode)}</td>` +
                                `<td style="padding:3px 6px">${e.origin} â†’ ${e.destination}</td>` +
                                '</tr>';
                        });
                        html += '</tbody></table>';
                        if (data.length === 0) html = '<em>No transit log data found.</em>';
                        html += `<div style="margin-top:6px;color:#888;font-size:0.8em">${data.length} unique approaches logged. ` +
                            `<span style="color:#ff4444">â– </span> &lt;0.25Â° (inside disk) ` +
                            `<span style="color:#ff9900">â– </span> &lt;0.5Â° (disk edge) ` +
                            `<span style="color:#ccc">â– </span> &gt;0.5Â°</div>`;
                        document.getElementById('nearMissContent').innerHTML = html;
                    })
                    .catch(() => {
                        document.getElementById('nearMissContent').textContent = 'Failed to load transit log.';
                    });
            }
        }

        loadPosition();

        // Auto-show results and map if position is saved
        window.addEventListener('DOMContentLoaded', function() {
            const savedLat = localStorage.getItem("latitude");
            const savedLon = localStorage.getItem("longitude");
            if (savedLat && savedLat !== "" && savedLat !== "null") {
                // Show map immediately so it loads tiles while waiting for flight data
                const mapContainer = document.getElementById("mapContainer");
                if (mapContainer) mapContainer.style.display = 'block';
                mapVisible = true;
                const lat = parseFloat(savedLat);
                const lon = parseFloat(savedLon || "0");
                if (!isNaN(lat) && !isNaN(lon) && typeof initializeMap === 'function') {
                    initializeMap(lat, lon);
                }

                // Fetch flight data shortly after
                setTimeout(() => {
                    go();
                }, 100);
            }
        });
    </script>
</body>
</html>
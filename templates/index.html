<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flymoon app</title>
    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}?v=1770230886">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css?v=2"
        crossorigin=""/>
</head>
<body>
    <div class="header-row">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Flymoon Transit Tracker" class="logo" />
        <div style="flex: 1; text-align: center;">
            <span id="trackingStatus" class="status-text"></span>
            <div id="lastUpdateStatus" style="font-size: 0.85em; color: #ccc; margin-top: 4px;"></div>
            <div id="celestialPositions" style="font-size: 0.85em; color: #ddd; margin-top: 2px;"></div>
        </div>
        <div style="display: flex; gap: 8px;">
            <a href="/telescope" class="btn-sm" title="Control Telescope" style="position: relative;">
                ğŸ”­ Telescope
                <span id="telescopeStatusLight" style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background-color: #999;" title="Telescope disconnected"></span>
            </a>
            <a href="/gallery" class="btn-sm" title="View Transit Image Gallery">ğŸ“¸ Gallery</a>
        </div>
        <!-- Quadrant Min Altitude Control -->
        <div class="quadrant-circle">
            <!-- Labels outside circle -->
            <label class="quadrant-label quadrant-label-n">N</label>
            <label class="quadrant-label quadrant-label-e">E</label>
            <label class="quadrant-label quadrant-label-s">S</label>
            <label class="quadrant-label quadrant-label-w">W</label>
            <!-- Inputs inside quadrants -->
            <input type="number" id="minAltN" class="quadrant-input quadrant-input-n" placeholder="30" min="0" max="90" title="North Min Altitude (Â°)">
            <input type="number" id="minAltE" class="quadrant-input quadrant-input-e" placeholder="30" min="0" max="90" title="East Min Altitude (Â°)">
            <input type="number" id="minAltS" class="quadrant-input quadrant-input-s" placeholder="30" min="0" max="90" title="South Min Altitude (Â°)">
            <input type="number" id="minAltW" class="quadrant-input quadrant-input-w" placeholder="30" min="0" max="90" title="West Min Altitude (Â°)">
            <div class="quadrant-center" onclick="resetQuadrantValues()" title="Click to reset all to 0">Min Alt (Â°)</div>
        </div>
    </div>

    <div class="controls-row">
        <button id="goBtn" class="btn-primary" onclick="go();">Refresh</button>
        <span class="separator">|</span>
        <div style="display: inline-block; text-align: center;">
            <input type="number" id="latitude" placeholder="Lat" autocomplete="on" title="Latitude">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Observer Lat</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <input type="number" id="longitude" placeholder="Lon" autocomplete="on" title="Longitude">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Observer Lon</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <input type="number" id="elevation" placeholder="Elev" autocomplete="on" title="Elevation (m)">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Elevation (m)</div>
        </div>
        <span class="separator">|</span>
        <div style="display: inline-block; text-align: center;">
            <input type="number" id="altThreshold" placeholder="Alt Î”" autocomplete="on" title="Max altitude difference for transit (degrees)" step="0.5" min="0.5" max="20" style="width: 70px;">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Alt Î” (Â°)</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <input type="number" id="azThreshold" placeholder="Az Î”" autocomplete="on" title="Max azimuth difference for transit (degrees)" step="1" min="1" max="180" style="width: 70px;">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Az Î” (Â°)</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <button class="btn-sm" onclick="savePosition()" title="Save position">ğŸ’¾</button>
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Save</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <button class="btn-sm" onclick="clearPosition()" title="Clear" style="font-size: 1.2em;">âœ•</button>
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Clear</div>
        </div>
        <span class="separator">|</span>
        <div style="display: inline-block; text-align: center;">
            <button class="btn-sm" onclick="toggleMap()" title="Toggle map">ğŸ—ºï¸</button>
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Map</div>
        </div>
        <div style="display: inline-block; text-align: center;">
            <button class="btn-sm" onclick="requestNotificationPermission()" title="Enable alerts">ğŸ””</button>
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Alerts</div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loadingSpinner" style="display: none; text-align: center; padding: 20px;">
        <div style="display: inline-block; width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="margin-top: 10px; color: #666;">Loading flight data...</p>
    </div>
    <style>
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <div id="transitCountdown" style="display: none; text-align: center; font-size: 1.5em; font-weight: bold; padding: 15px; margin: 10px 0; border-radius: 5px;"></div>

    <div id="mapContainer" style="display: none;">
        <div style="display: flex; align-items: flex-start; gap: 0;">
            <div id="map" style="height: 500px; flex: 1; margin: 20px 0;"></div>
            <!-- Altitude Overlay -->
            <div id="altitudeOverlay">
                <div class="altitude-header">Aircraft Altitudes</div>
                <div class="altitude-scale">
                    <div class="altitude-tick" style="top: 0%;">45k</div>
                    <div class="altitude-tick" style="top: 11.1%;">40k</div>
                    <div class="altitude-tick" style="top: 22.2%;">35k</div>
                    <div class="altitude-tick" style="top: 33.3%;">30k</div>
                    <div class="altitude-tick" style="top: 44.4%;">25k</div>
                    <div class="altitude-tick" style="top: 55.6%;">20k</div>
                    <div class="altitude-tick" style="top: 66.7%;">15k</div>
                    <div class="altitude-tick" style="top: 77.8%;">10k</div>
                    <div class="altitude-tick" style="top: 88.9%;">5k</div>
                    <div class="altitude-tick" style="top: 100%;">0</div>
                </div>
                <div class="altitude-grid">
                    <div class="altitude-grid-line" style="bottom: 100%;"></div>
                    <div class="altitude-grid-line" style="bottom: 88.9%;"></div>
                    <div class="altitude-grid-line" style="bottom: 77.8%;"></div>
                    <div class="altitude-grid-line" style="bottom: 66.7%;"></div>
                    <div class="altitude-grid-line" style="bottom: 55.6%;"></div>
                    <div class="altitude-grid-line" style="bottom: 44.4%;"></div>
                    <div class="altitude-grid-line" style="bottom: 33.3%;"></div>
                    <div class="altitude-grid-line" style="bottom: 22.2%;"></div>
                    <div class="altitude-grid-line" style="bottom: 11.1%;"></div>
                    <div class="altitude-grid-line" style="bottom: 0%;"></div>
                </div>
                <div id="altitudeBars"></div>
            </div>
        </div>
        <div id="mapLegend" style="padding: 10px; background: #f0f0f0; margin-bottom: 10px;">
            <strong>Legend:</strong>
            <span style="margin-left: 10px;">ğŸ“ Observer</span>
            <span style="margin-left: 10px;">âœˆï¸ Aircraft</span>
            <span style="margin-left: 10px; color: #32CD32;">â—† High</span>
            <span style="margin-left: 10px; color: #FF8C00;">â—† Medium</span>
            <span style="margin-left: 10px; color: #FFD700;">â—† Low</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 16px; height: 12px; border: 2px dashed red; vertical-align: middle;"></span> Bounding box</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #FF4500; vertical-align: middle;"></span> Sun azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #4169E1; vertical-align: middle;"></span> Moon azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 3px; background: repeating-linear-gradient(90deg, #000 0, #000 10px, transparent 10px, transparent 15px); vertical-align: middle;"></span> Track</span>
        </div>
    </div>

    <div id="results">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>target</th>
                    <th>id</th>
                    <th>type</th>
                    <th>origin</th>
                    <th>destination</th>
                    <th>target<br>angle</th>
                    <th>plane<br>angle</th>
                    <th>â–³angle</th>
                    <th>target<br>az</th>
                    <th>plane<br>az</th>
                    <th>â–³az</th>
                    <th>elev</th>
                    <th>GPS alt<br>(ft)</th>
                    <th>hdg</th>
                    <th>dist<br>(nm)</th>
                </tr>
            </thead>
            <tbody id="flightData">
            </tbody>
        </table>
    </div>
    <h3 class="alert" id="noResults"></h3>
    <h3 class="alert" id="targetUnderHorizon"></h3>

    <footer class="attribution-footer">
        <p><i>Created with deep appreciation for the idea and initial design by David Betancourt Montellano</i></p>
        <p><i>Creado con profundo agradecimiento por la idea y el diseÃ±o inicial de David Betancourt Montellano</i></p>
    </footer>

    <audio id="alertSound" src="{{ url_for('static', filename='sounds/tissman-alert1-maximum-distortion.mp3') }}" preload="auto">
    </audio>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js?v=2"
        crossorigin=""></script>
    <!-- Leaflet Editable for draggable shapes -->
    <script src="https://unpkg.com/leaflet-editable@1.2.0/src/Leaflet.Editable.js"></script>
    <script src="{{ url_for('static', filename='map.js') }}?v=1770230596" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='app.js') }}?v=1770237941" charset="utf-8"></script>

    <script>
        loadPosition();

        // Auto-show results and map if position is saved
        window.addEventListener('DOMContentLoaded', function() {
            const savedLat = localStorage.getItem("latitude");
            if (savedLat && savedLat !== "" && savedLat !== "null") {
                // Position is saved, auto-fetch and show results
                setTimeout(() => {
                    go();  // This will toggle results on and fetch data
                }, 100);
            }
        });
    </script>
</body>
</html>
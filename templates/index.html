<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Flymoon app</title>
    <!-- favicon -->
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='images/favicon.ico') }}">
    <!-- CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='main.css') }}?v=1770230886">
    <!-- Leaflet CSS (self-hosted for security) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='leaflet.css') }}" />
</head>
<body>
    <div class="header-row">
        <img src="{{ url_for('static', filename='images/logo.svg') }}" alt="Flymoon Transit Tracker" class="logo" />
        <div style="flex: 1; text-align: center;">
            <span id="trackingStatus" class="status-text"></span>
            <div id="lastUpdateStatus" style="font-size: 0.85em; color: #ccc; margin-top: 4px;"></div>
            <div id="celestialPositions" style="font-size: 0.85em; color: #ddd; margin-top: 2px;"></div>
        </div>
        <div style="display: flex; gap: 8px;">
            <a href="/telescope" target="_blank" class="btn-sm" title="Control Telescope" style="position: relative;">
                üî≠ Telescope
                <span id="telescopeStatusLight" style="position: absolute; top: 2px; right: 2px; width: 8px; height: 8px; border-radius: 50%; background-color: #999;" title="Telescope disconnected"></span>
            </a>
        </div>
        <!-- Quadrant Min Altitude Control -->
        <div class="quadrant-circle">
            <!-- Labels outside circle -->
            <label class="quadrant-label quadrant-label-n">N</label>
            <label class="quadrant-label quadrant-label-e">E</label>
            <label class="quadrant-label quadrant-label-s">S</label>
            <label class="quadrant-label quadrant-label-w">W</label>
            <!-- Inputs inside quadrants -->
            <input type="number" id="minAltN" class="quadrant-input quadrant-input-n" placeholder="30" min="0" max="90" title="North Min Altitude (¬∞)">
            <input type="number" id="minAltE" class="quadrant-input quadrant-input-e" placeholder="30" min="0" max="90" title="East Min Altitude (¬∞)">
            <input type="number" id="minAltS" class="quadrant-input quadrant-input-s" placeholder="30" min="0" max="90" title="South Min Altitude (¬∞)">
            <input type="number" id="minAltW" class="quadrant-input quadrant-input-w" placeholder="30" min="0" max="90" title="West Min Altitude (¬∞)">
            <div class="quadrant-center" onclick="resetQuadrantValues()" title="Click to reset all to 0">Min Angle</div>
        </div>
    </div>

    <div class="controls-row">
        <button id="goBtn" class="btn-primary" onclick="go();" title="Force immediate API refresh (not recommended - wastes quota)">‚ü≥ Force Refresh</button>
        <span class="separator">|</span>
        <div class="control-group">
            <input type="number" id="latitude" placeholder="Lat" autocomplete="on" title="Latitude">
            <div class="control-label">Observer Lat</div>
        </div>
        <div class="control-group">
            <input type="number" id="longitude" placeholder="Lon" autocomplete="on" title="Longitude">
            <div class="control-label">Observer Lon</div>
        </div>
        <div class="control-group">
            <input type="number" id="elevation" placeholder="Elev" autocomplete="on" title="Elevation (m)">
            <div class="control-label">Elevation (m)</div>
        </div>
        <span class="separator">|</span>
        <div class="control-group">
            <button class="btn-sm" onclick="savePosition()" title="Save position">üíæ</button>
            <div class="control-label">Save</div>
        </div>
        <div class="control-group">
            <button class="btn-sm btn-lg-icon" onclick="clearPosition()" title="Clear">‚úï</button>
            <div class="control-label">Clear</div>
        </div>
        <span class="separator">|</span>
        <div class="control-group">
            <button class="btn-sm" onclick="toggleMap()" title="Toggle map">üó∫Ô∏è</button>
            <div class="control-label">Map</div>
        </div>
        <div class="control-group">
            <button class="btn-sm" onclick="toggleAlerts()" title="Enable/disable alerts">üîî</button>
            <div class="control-label">Alerts</div>
        </div>
        <span class="separator">|</span>
        <div style="display: inline-block; text-align: center;">
            <input type="checkbox" id="pauseWhenHidden" onchange="togglePauseWhenHidden()" title="Pause auto-refresh when page is hidden" style="width: 18px; height: 18px; cursor: pointer;">
            <div style="font-size: 0.7em; color: #aaa; margin-top: -2px;">Pause Hidden</div>
        </div>
    </div>

    <!-- Loading spinner -->
    <div id="loadingSpinner" style="display: none;">
        <div class="loading-spinner"></div>
        <p class="loading-text">Loading flight data...</p>
    </div>

    <div id="transitCountdown" style="display: none; text-align: center; font-size: 1.5em; font-weight: bold; padding: 15px; margin: 10px 0; border-radius: 5px;"></div>

    <div id="mapContainer" style="display: none;">
        <div style="display: flex; align-items: flex-start; gap: 0;">
            <div id="map" style="height: 500px; flex: 1; margin: 20px 0;"></div>
            <!-- Altitude Overlay -->
            <div id="altitudeOverlay">
                <div class="altitude-header">Aircraft Altitudes</div>
                <div class="altitude-scale">
                    <div class="altitude-tick" style="top: 0%;">45k</div>
                    <div class="altitude-tick" style="top: 11.1%;">40k</div>
                    <div class="altitude-tick" style="top: 22.2%;">35k</div>
                    <div class="altitude-tick" style="top: 33.3%;">30k</div>
                    <div class="altitude-tick" style="top: 44.4%;">25k</div>
                    <div class="altitude-tick" style="top: 55.6%;">20k</div>
                    <div class="altitude-tick" style="top: 66.7%;">15k</div>
                    <div class="altitude-tick" style="top: 77.8%;">10k</div>
                    <div class="altitude-tick" style="top: 88.9%;">5k</div>
                    <div class="altitude-tick" style="top: 100%;">0</div>
                </div>
                <div class="altitude-grid">
                    <div class="altitude-grid-line" style="bottom: 100%;"></div>
                    <div class="altitude-grid-line" style="bottom: 88.9%;"></div>
                    <div class="altitude-grid-line" style="bottom: 77.8%;"></div>
                    <div class="altitude-grid-line" style="bottom: 66.7%;"></div>
                    <div class="altitude-grid-line" style="bottom: 55.6%;"></div>
                    <div class="altitude-grid-line" style="bottom: 44.4%;"></div>
                    <div class="altitude-grid-line" style="bottom: 33.3%;"></div>
                    <div class="altitude-grid-line" style="bottom: 22.2%;"></div>
                    <div class="altitude-grid-line" style="bottom: 11.1%;"></div>
                    <div class="altitude-grid-line" style="bottom: 0%;"></div>
                </div>
                <div id="altitudeBars"></div>
            </div>
        </div>
        <div id="mapLegend" style="padding: 10px; background: #f0f0f0; margin-bottom: 10px;">
            <strong>Legend:</strong>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 8px; height: 8px; background-color: #FF0000; border: 1px solid white; border-radius: 50%; box-shadow: 0 0 3px rgba(0,0,0,0.6); vertical-align: middle;"></span> Observer</span>
            <span style="margin-left: 10px;">‚úàÔ∏è Aircraft</span>
            <span style="margin-left: 10px; color: #32CD32;">‚óÜ High (‚â§1¬∞)</span>
            <span style="margin-left: 10px; color: #FF8C00;">‚óÜ Medium (‚â§2¬∞)</span>
            <span style="margin-left: 10px; color: #808080;">‚óÜ Low (‚â§3¬∞)</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 16px; height: 12px; border: 2px dashed red; vertical-align: middle;"></span> Bounding box</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #FF4500; vertical-align: middle;"></span> Sun azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 4px; background: #4169E1; vertical-align: middle;"></span> Moon azimuth</span>
            <span style="margin-left: 10px;"><span style="display: inline-block; width: 20px; height: 3px; background: repeating-linear-gradient(90deg, #000 0, #000 10px, transparent 10px, transparent 15px); vertical-align: middle;"></span> Track</span>
        </div>
    </div>

    <div id="results">
        <table id="resultsTable">
            <thead>
                <tr>
                    <th>target</th>
                    <th>id</th>
                    <th>type</th>
                    <th style="max-width: 60px; overflow: hidden; text-overflow: ellipsis;">origin</th>
                    <th style="max-width: 60px; overflow: hidden; text-overflow: ellipsis;">dest</th>
                    <th>target<br>angle</th>
                    <th>plane<br>angle</th>
                    <th>target<br>az</th>
                    <th>plane<br>az</th>
                    <th>‚ñ≥angle</th>
                    <th>‚ñ≥az</th>
                    <th>elev</th>
                    <th>GPS alt<br>(ft)</th>
                    <th>Hdg (T)</th>
                    <th>dist<br>(km/miles)</th>
                    <th>speed<br>(mph)</th>
                </tr>
            </thead>
            <tbody id="flightData">
            </tbody>
        </table>
    </div>
    <h3 class="alert" id="noResults"></h3>
    <h3 class="alert" id="targetUnderHorizon"></h3>
    <div id="errorBanner" style="display:none; background:#ffebee; border:1px solid #f44336; border-radius:6px; padding:12px 16px; margin:10px 0; color:#b71c1c; font-family:monospace; font-size:13px; white-space:pre-wrap; word-break:break-word;"></div>

    <footer class="attribution-footer">
        <p><i>Created with deep appreciation for the idea and initial design by David Betancourt Montellano</i></p>
        <p><i>Creado con profundo agradecimiento por la idea y el dise√±o inicial de David Betancourt Montellano</i></p>
    </footer>

    <audio id="alertSound" src="{{ url_for('static', filename='sounds/tissman-alert1-maximum-distortion.mp3') }}" preload="auto">
    </audio>

    <!-- Leaflet JS and plugins (self-hosted for security) -->
    <script src="{{ url_for('static', filename='leaflet.js') }}"
        crossorigin=""></script>
    <!-- Leaflet Editable plugin for bounding box editing -->
    <script src="{{ url_for('static', filename='leaflet-editable.js') }}"></script>
    <script src="{{ url_for('static', filename='map.js') }}?v=1771600000" charset="utf-8"></script>
    <script src="{{ url_for('static', filename='app.js') }}?v=1771610000" charset="utf-8"></script>

    <script>
        loadPosition();

        // Auto-show results and map if position is saved
        window.addEventListener('DOMContentLoaded', function() {
            const savedLat = localStorage.getItem("latitude");
            const savedLon = localStorage.getItem("longitude");
            if (savedLat && savedLat !== "" && savedLat !== "null") {
                // Show map immediately so it loads tiles while waiting for flight data
                const mapContainer = document.getElementById("mapContainer");
                if (mapContainer) mapContainer.style.display = 'block';
                mapVisible = true;
                const lat = parseFloat(savedLat);
                const lon = parseFloat(savedLon || "0");
                if (!isNaN(lat) && !isNaN(lon) && typeof initializeMap === 'function') {
                    initializeMap(lat, lon);
                }

                // Fetch flight data shortly after
                setTimeout(() => {
                    go();
                }, 100);
            }
        });
    </script>
</body>
</html>
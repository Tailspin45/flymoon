<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Flymoon Setup</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    background: #0d0d1a;
    color: #e0e0e0;
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
  .wizard-header {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    padding: 20px 28px 16px;
    border-bottom: 1px solid #2a2a4a;
  }
  .wizard-header h1 {
    font-size: 1.4em;
    color: #fff;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .wizard-header .subtitle { font-size: 0.82em; color: #888; margin-top: 4px; }
  /* ‚îÄ‚îÄ Step indicators ‚îÄ‚îÄ */
  .steps {
    display: flex;
    gap: 6px;
    padding: 0 28px;
    margin-top: 10px;
  }
  .step-dot {
    flex: 1;
    height: 3px;
    border-radius: 2px;
    background: #2a2a4a;
    transition: background 0.3s;
  }
  .step-dot.active  { background: #4a9eff; }
  .step-dot.done    { background: #2ecc71; }
  /* ‚îÄ‚îÄ Body ‚îÄ‚îÄ */
  .wizard-body {
    flex: 1;
    overflow-y: auto;
    padding: 24px 28px;
  }
  .step-panel { display: none; }
  .step-panel.active { display: block; }
  h2 { font-size: 1.1em; color: #fff; margin-bottom: 6px; }
  .step-desc { font-size: 0.85em; color: #888; margin-bottom: 18px; line-height: 1.5; }
  /* ‚îÄ‚îÄ Form elements ‚îÄ‚îÄ */
  .field { margin-bottom: 14px; }
  label { display: block; font-size: 0.82em; color: #aaa; margin-bottom: 5px; }
  label .req { color: #e74c3c; }
  input[type=text], input[type=number], input[type=password] {
    width: 100%;
    background: #1a1a2e;
    border: 1px solid #2a2a4a;
    border-radius: 6px;
    padding: 8px 10px;
    color: #e0e0e0;
    font-size: 0.9em;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus { border-color: #4a9eff; }
  .field-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
  .field-row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .help-link {
    display: inline-block;
    font-size: 0.78em;
    color: #4a9eff;
    cursor: pointer;
    text-decoration: underline;
    margin-top: 4px;
  }
  .help-link:hover { color: #79b8ff; }
  /* ‚îÄ‚îÄ Auto-detect button ‚îÄ‚îÄ */
  .detect-btn {
    background: #1e3a5f;
    border: 1px solid #4a9eff;
    border-radius: 6px;
    color: #4a9eff;
    padding: 7px 14px;
    font-size: 0.85em;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    margin-bottom: 14px;
    width: 100%;
    justify-content: center;
    transition: background 0.2s;
  }
  .detect-btn:hover { background: #253d5e; }
  .detect-btn:disabled { opacity: 0.5; cursor: default; }
  /* ‚îÄ‚îÄ Optional badge ‚îÄ‚îÄ */
  .optional-badge {
    display: inline-block;
    background: #2a2a4a;
    color: #888;
    font-size: 0.7em;
    padding: 1px 7px;
    border-radius: 10px;
    margin-left: 6px;
    vertical-align: middle;
  }
  /* ‚îÄ‚îÄ Toggle ‚îÄ‚îÄ */
  .toggle-row {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 14px;
  }
  .toggle-row label { margin-bottom: 0; font-size: 0.9em; color: #ddd; }
  input[type=checkbox] { width: 16px; height: 16px; cursor: pointer; }
  /* ‚îÄ‚îÄ Info box ‚îÄ‚îÄ */
  .info-box {
    background: #1a1a2e;
    border: 1px solid #2a2a4a;
    border-left: 3px solid #4a9eff;
    border-radius: 4px;
    padding: 10px 14px;
    font-size: 0.82em;
    color: #aaa;
    margin-bottom: 14px;
    line-height: 1.5;
  }
  .info-box a { color: #4a9eff; cursor: pointer; }
  /* ‚îÄ‚îÄ Review table ‚îÄ‚îÄ */
  .review-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
  .review-table td { padding: 5px 8px; border-bottom: 1px solid #1e1e35; }
  .review-table td:first-child { color: #888; width: 45%; }
  .review-table td:last-child  { color: #e0e0e0; }
  /* ‚îÄ‚îÄ Error ‚îÄ‚îÄ */
  .error-msg { color: #e74c3c; font-size: 0.82em; margin-top: 4px; display: none; }
  /* ‚îÄ‚îÄ Footer ‚îÄ‚îÄ */
  .wizard-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px 28px;
    border-top: 1px solid #2a2a4a;
    background: #0d0d1a;
  }
  .btn {
    padding: 9px 22px;
    border-radius: 6px;
    border: none;
    font-size: 0.9em;
    cursor: pointer;
    transition: opacity 0.2s;
  }
  .btn:disabled { opacity: 0.4; cursor: default; }
  .btn-secondary { background: #2a2a4a; color: #aaa; }
  .btn-primary   { background: #4a9eff; color: #fff; }
  .btn-success   { background: #2ecc71; color: #fff; }
  .step-counter  { font-size: 0.8em; color: #555; }
  /* ‚îÄ‚îÄ Welcome step ‚îÄ‚îÄ */
  .welcome-hero {
    text-align: center;
    padding: 10px 0 20px;
  }
  .welcome-hero .logo { font-size: 3em; margin-bottom: 10px; }
  .welcome-hero h2 { font-size: 1.3em; margin-bottom: 8px; }
  .welcome-hero p  { font-size: 0.88em; color: #888; line-height: 1.6; max-width: 460px; margin: 0 auto 14px; }
  .feature-list { text-align: left; max-width: 380px; margin: 0 auto; }
  .feature-list li { font-size: 0.85em; color: #aaa; margin-bottom: 6px; list-style: none; padding-left: 20px; position: relative; }
  .feature-list li::before { content: '‚úì'; position: absolute; left: 0; color: #2ecc71; }
</style>
</head>
<body>

<div class="wizard-header">
  <h1>üî≠ Flymoon Setup</h1>
  <div class="subtitle">Configure your installation ‚Äî takes about 2 minutes</div>
  <div class="steps">
    <div class="step-dot active" id="dot-0"></div>
    <div class="step-dot" id="dot-1"></div>
    <div class="step-dot" id="dot-2"></div>
    <div class="step-dot" id="dot-3"></div>
    <div class="step-dot" id="dot-4"></div>
    <div class="step-dot" id="dot-5"></div>
  </div>
</div>

<div class="wizard-body">

  <!-- Step 0: Welcome -->
  <div class="step-panel active" id="step-0">
    <div class="welcome-hero">
      <div class="logo">üåô‚òÄÔ∏è‚úàÔ∏è</div>
      <h2>Welcome to Flymoon</h2>
      <p>Flymoon detects aircraft transiting the Sun and Moon in real time, and can automatically trigger your Seestar telescope to capture the event.</p>
      <ul class="feature-list">
        <li>Live flight tracking via FlightAware AeroAPI</li>
        <li>Celestial position calculations (no internet needed for sky math)</li>
        <li>Telegram push notifications for high-probability transits</li>
        <li>Seestar S50 telescope auto-capture control</li>
        <li>Interactive map with transit overlay</li>
      </ul>
    </div>
    <div class="info-box">
      You'll need a <strong>free FlightAware developer account</strong> to get your API key. A Telegram bot and Seestar telescope are optional.
    </div>
  </div>

  <!-- Step 1: FlightAware API Key -->
  <div class="step-panel" id="step-1">
    <h2>‚úàÔ∏è FlightAware API Key</h2>
    <p class="step-desc">Flymoon uses FlightAware AeroAPI to fetch real-time aircraft positions near you. A free Personal tier account includes 10 requests/minute ‚Äî enough for continuous monitoring.</p>
    <div class="info-box">
      1. Sign up at <a onclick="open_('https://www.flightaware.com/aeroapi/portal/')">flightaware.com/aeroapi/portal</a><br>
      2. Create a new API key under the "Personal" plan<br>
      3. Paste the key below
    </div>
    <div class="field">
      <label>AeroAPI Key <span class="req">*</span></label>
      <input type="text" id="aeroapi_key" placeholder="AbCdEf1234567890..." autocomplete="off" spellcheck="false">
      <div class="error-msg" id="err-aeroapi">Please enter your FlightAware AeroAPI key</div>
    </div>
  </div>

  <!-- Step 2: Observer Location -->
  <div class="step-panel" id="step-2">
    <h2>üìç Your Location</h2>
    <p class="step-desc">Flymoon calculates the Sun and Moon's position relative to where you are. Your location stays on this device and is never shared.</p>
    <button class="detect-btn" id="detectBtn" onclick="detectLocation()">
      <span id="detectIcon">üì°</span> Auto-detect my location
    </button>
    <div class="field-row">
      <div class="field">
        <label>Latitude <span class="req">*</span></label>
        <input type="number" id="latitude" placeholder="e.g. 34.052" step="0.001">
      </div>
      <div class="field">
        <label>Longitude <span class="req">*</span></label>
        <input type="number" id="longitude" placeholder="e.g. -118.243" step="0.001">
      </div>
      <div class="field">
        <label>Elevation (m)</label>
        <input type="number" id="elevation" placeholder="0" step="1" min="0">
      </div>
    </div>
    <div class="error-msg" id="err-location" style="display:none">Please enter your latitude and longitude</div>
    <div class="info-box" style="margin-top:8px; font-size:0.8em; color:#666;">
      Elevation is fetched automatically when you use auto-detect. You can also find it at <a onclick="open_('https://www.whatismyelevation.com')">whatismyelevation.com</a>.
    </div>
  </div>

  <!-- Step 3: Bounding Box -->
  <div class="step-panel" id="step-3">
    <h2>üó∫Ô∏è Search Area</h2>
    <p class="step-desc">Flymoon searches for aircraft within a rectangular area around your location. A ¬±2¬∞ box (~220 km) works well for most observers.</p>
    <button class="detect-btn" id="autoBoxBtn" onclick="autoBox()">
      ‚ö° Auto-compute from my location (¬±2¬∞)
    </button>
    <div class="field-row-2">
      <div class="field">
        <label>SW Corner ‚Äî Latitude</label>
        <input type="number" id="bbox_lat_ll" placeholder="Lower-left lat" step="0.01">
      </div>
      <div class="field">
        <label>SW Corner ‚Äî Longitude</label>
        <input type="number" id="bbox_lon_ll" placeholder="Lower-left lon" step="0.01">
      </div>
      <div class="field">
        <label>NE Corner ‚Äî Latitude</label>
        <input type="number" id="bbox_lat_ur" placeholder="Upper-right lat" step="0.01">
      </div>
      <div class="field">
        <label>NE Corner ‚Äî Longitude</label>
        <input type="number" id="bbox_lon_ur" placeholder="Upper-right lon" step="0.01">
      </div>
    </div>
    <div class="error-msg" id="err-bbox">Please fill in all four bounding box values</div>
  </div>

  <!-- Step 4: Telegram (optional) -->
  <div class="step-panel" id="step-4">
    <h2>üì± Telegram Notifications <span class="optional-badge">optional</span></h2>
    <p class="step-desc">Receive a push notification on your phone when a high-probability transit is detected. Skip this step if you only want the web interface.</p>
    <div class="info-box">
      1. Open Telegram and start a chat with <a onclick="open_('https://t.me/botfather')">@BotFather</a><br>
      2. Send <code>/newbot</code> and follow the prompts to get a <strong>Bot Token</strong><br>
      3. Send any message to your new bot, then open:<br>
      &nbsp;&nbsp;<a onclick="open_('https://api.telegram.org/bot{YOUR_TOKEN}/getUpdates')">api.telegram.org/bot{token}/getUpdates</a><br>
      4. Your <strong>Chat ID</strong> is the <code>"id"</code> field in the <code>chat</code> object
    </div>
    <div class="field">
      <label>Bot Token</label>
      <input type="text" id="telegram_token" placeholder="123456789:AABBccdd..." autocomplete="off" spellcheck="false">
    </div>
    <div class="field">
      <label>Chat ID</label>
      <input type="text" id="telegram_chat" placeholder="987654321" autocomplete="off" spellcheck="false">
    </div>
  </div>

  <!-- Step 5: Seestar (optional) -->
  <div class="step-panel" id="step-5">
    <h2>üî≠ Seestar Telescope <span class="optional-badge">optional</span></h2>
    <p class="step-desc">If you have a Seestar S50 on your local network, Flymoon can automatically start recording when a transit is imminent.</p>
    <div class="toggle-row">
      <input type="checkbox" id="seestar_enabled" onchange="toggleSeestar()">
      <label for="seestar_enabled">Enable Seestar integration</label>
    </div>
    <div id="seestar_fields" style="display:none">
      <div class="info-box">
        Make sure your Seestar is on the same Wi-Fi network and is in Solar or Lunar viewing mode before starting a monitoring session.
        See <strong>Help ‚Üí Telescope Guide</strong> for detailed setup instructions.
      </div>
      <div class="field-row-2">
        <div class="field">
          <label>Seestar IP Address</label>
          <input type="text" id="seestar_host" placeholder="192.168.1.x" spellcheck="false">
        </div>
        <div class="field">
          <label>Port (default 4700)</label>
          <input type="number" id="seestar_port" value="4700" min="1" max="65535">
        </div>
      </div>
    </div>
    <div id="seestar_skip_note" class="info-box">
      You can enable Seestar later from <strong>File ‚Üí Preferences</strong>.
    </div>
  </div>

  <!-- Step 6 (implicit via review in footer): Review ‚Äî shown as a summary overlay -->
  <div class="step-panel" id="step-review" style="display:none">
    <h2>‚úÖ Review &amp; Finish</h2>
    <p class="step-desc">Double-check your settings then click <strong>Launch Flymoon</strong>.</p>
    <table class="review-table" id="reviewTable"></table>
    <div class="info-box" style="margin-top:14px">
      You can change any setting later from <strong>File ‚Üí Preferences</strong>.
    </div>
  </div>

</div>

<div class="wizard-footer">
  <button class="btn btn-secondary" id="btnBack" onclick="back()" style="display:none">‚Üê Back</button>
  <span class="step-counter" id="stepCounter">Step 1 of 6</span>
  <button class="btn btn-primary" id="btnNext" onclick="next()">Next ‚Üí</button>
</div>

<script>
const STEPS = ['step-0','step-1','step-2','step-3','step-4','step-5','step-review'];
let current = 0;

function open_(url) {
    if (window.flymoon) window.flymoon.openExternal(url);
    else window.open(url, '_blank');
}

function showStep(idx) {
    STEPS.forEach((id, i) => {
        const el = document.getElementById(id);
        if (el) el.style.display = i === idx ? '' : 'none';
        if (el) el.classList.toggle('active', i === idx);
    });
    // dots
    for (let i = 0; i < 6; i++) {
        const d = document.getElementById(`dot-${i}`);
        if (!d) continue;
        d.className = 'step-dot' + (i < idx ? ' done' : i === idx ? ' active' : '');
    }
    document.getElementById('btnBack').style.display = idx > 0 ? '' : 'none';
    const isLast = idx === STEPS.length - 1;
    const btnNext = document.getElementById('btnNext');
    btnNext.textContent = isLast ? 'üöÄ Launch Flymoon' : 'Next ‚Üí';
    btnNext.className   = 'btn ' + (isLast ? 'btn-success' : 'btn-primary');
    document.getElementById('stepCounter').textContent = `Step ${Math.min(idx+1, 6)} of 6`;
    if (isLast) buildReview();
}

function validate() {
    if (current === 1) {
        const key = document.getElementById('aeroapi_key').value.trim();
        if (!key) { show('err-aeroapi'); return false; }
        hide('err-aeroapi');
    }
    if (current === 2) {
        const lat = document.getElementById('latitude').value.trim();
        const lon = document.getElementById('longitude').value.trim();
        if (!lat || !lon) { show('err-location'); return false; }
        hide('err-location');
    }
    if (current === 3) {
        const fields = ['bbox_lat_ll','bbox_lon_ll','bbox_lat_ur','bbox_lon_ur'];
        if (fields.some(f => !document.getElementById(f).value.trim())) {
            show('err-bbox'); return false;
        }
        hide('err-bbox');
    }
    return true;
}

function next() {
    if (!validate()) return;
    if (current < STEPS.length - 1) {
        current++;
        showStep(current);
    } else {
        finish();
    }
}

function back() {
    if (current > 0) { current--; showStep(current); }
}

function show(id) { const e = document.getElementById(id); if(e) e.style.display='block'; }
function hide(id) { const e = document.getElementById(id); if(e) e.style.display='none'; }

function toggleSeestar() {
    const on = document.getElementById('seestar_enabled').checked;
    document.getElementById('seestar_fields').style.display = on ? 'block' : 'none';
    document.getElementById('seestar_skip_note').style.display = on ? 'none' : 'block';
}

function autoBox() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lon = parseFloat(document.getElementById('longitude').value);
    if (isNaN(lat) || isNaN(lon)) {
        alert('Please complete your location in Step 2 first.');
        return;
    }
    const d = 2.0;
    document.getElementById('bbox_lat_ll').value = (lat - d).toFixed(3);
    document.getElementById('bbox_lon_ll').value = (lon - d).toFixed(3);
    document.getElementById('bbox_lat_ur').value = (lat + d).toFixed(3);
    document.getElementById('bbox_lon_ur').value = (lon + d).toFixed(3);
}

async function detectLocation() {
    const btn = document.getElementById('detectBtn');
    const icon = document.getElementById('detectIcon');
    btn.disabled = true;
    icon.textContent = '‚è≥';

    if (!navigator.geolocation) {
        alert('Geolocation is not supported on this system. Please enter coordinates manually.');
        btn.disabled = false; icon.textContent = 'üì°';
        return;
    }

    navigator.geolocation.getCurrentPosition(
        async (pos) => {
            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            document.getElementById('latitude').value  = lat.toFixed(5);
            document.getElementById('longitude').value = lon.toFixed(5);
            icon.textContent = '‚úÖ';

            // Fetch elevation from Open-Elevation API (free, no key)
            try {
                const resp = await fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${lat},${lon}`);
                if (resp.ok) {
                    const data = await resp.json();
                    const elev = data.results[0].elevation;
                    document.getElementById('elevation').value = Math.round(elev);
                }
            } catch { /* elevation stays blank ‚Äî no big deal */ }

            btn.disabled = false;

            // Ask if they want to auto-fill bounding box too
            if (confirm('Location detected! Auto-fill the search area (¬±2¬∞ around your location)?')) {
                autoBox();
            }
        },
        (err) => {
            alert(`Location detection failed: ${err.message}\nPlease enter coordinates manually.`);
            btn.disabled = false;
            icon.textContent = 'üì°';
        },
        { enableHighAccuracy: false, timeout: 10000 }
    );
}

function buildReview() {
    const rows = [
        ['AeroAPI Key',    maskKey(document.getElementById('aeroapi_key').value)],
        ['Latitude',       document.getElementById('latitude').value],
        ['Longitude',      document.getElementById('longitude').value],
        ['Elevation',      (document.getElementById('elevation').value || '0') + ' m'],
        ['Search area SW', `${document.getElementById('bbox_lat_ll').value}, ${document.getElementById('bbox_lon_ll').value}`],
        ['Search area NE', `${document.getElementById('bbox_lat_ur').value}, ${document.getElementById('bbox_lon_ur').value}`],
        ['Telegram',       document.getElementById('telegram_token').value ? '‚úÖ Configured' : '‚Äî not set'],
        ['Seestar',        document.getElementById('seestar_enabled').checked
                             ? `‚úÖ ${document.getElementById('seestar_host').value}:${document.getElementById('seestar_port').value}`
                             : '‚Äî not enabled'],
    ];
    document.getElementById('reviewTable').innerHTML = rows.map(([k,v]) =>
        `<tr><td>${k}</td><td>${v}</td></tr>`
    ).join('');
}

function maskKey(k) {
    if (!k) return '‚Äî';
    return k.substring(0, 4) + '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢' + k.slice(-4);
}

async function finish() {
    const cfg = {
        aeroapi_key:     document.getElementById('aeroapi_key').value.trim(),
        latitude:        parseFloat(document.getElementById('latitude').value),
        longitude:       parseFloat(document.getElementById('longitude').value),
        elevation:       parseFloat(document.getElementById('elevation').value || 0),
        bbox_lat_ll:     parseFloat(document.getElementById('bbox_lat_ll').value),
        bbox_lon_ll:     parseFloat(document.getElementById('bbox_lon_ll').value),
        bbox_lat_ur:     parseFloat(document.getElementById('bbox_lat_ur').value),
        bbox_lon_ur:     parseFloat(document.getElementById('bbox_lon_ur').value),
        telegram_token:  document.getElementById('telegram_token').value.trim(),
        telegram_chat:   document.getElementById('telegram_chat').value.trim(),
        seestar_enabled: document.getElementById('seestar_enabled').checked,
        seestar_host:    document.getElementById('seestar_host').value.trim(),
        seestar_port:    parseInt(document.getElementById('seestar_port').value || 4700),
    };
    document.getElementById('btnNext').disabled = true;
    document.getElementById('btnNext').textContent = 'Starting‚Ä¶';
    if (window.flymoon) {
        await window.flymoon.wizardComplete(cfg);
    }
}

// Pre-fill from existing config if editing preferences
async function init() {
    if (!window.flymoon) return;
    const cfg = await window.flymoon.getConfig();
    if (!cfg || !cfg.aeroapi_key) return;
    document.getElementById('aeroapi_key').value   = cfg.aeroapi_key   || '';
    document.getElementById('latitude').value      = cfg.latitude      || '';
    document.getElementById('longitude').value     = cfg.longitude     || '';
    document.getElementById('elevation').value     = cfg.elevation     || '';
    document.getElementById('bbox_lat_ll').value   = cfg.bbox_lat_ll   || '';
    document.getElementById('bbox_lon_ll').value   = cfg.bbox_lon_ll   || '';
    document.getElementById('bbox_lat_ur').value   = cfg.bbox_lat_ur   || '';
    document.getElementById('bbox_lon_ur').value   = cfg.bbox_lon_ur   || '';
    document.getElementById('telegram_token').value= cfg.telegram_token|| '';
    document.getElementById('telegram_chat').value = cfg.telegram_chat || '';
    document.getElementById('seestar_enabled').checked = !!cfg.seestar_enabled;
    document.getElementById('seestar_host').value  = cfg.seestar_host  || '';
    document.getElementById('seestar_port').value  = cfg.seestar_port  || 4700;
    toggleSeestar();
}

showStep(0);
init();
</script>
</body>
</html>
